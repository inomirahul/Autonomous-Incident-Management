version: "3.9"

volumes:
  pgdata:

services:
  # --------------------------------------------------
  # Database (persistent memory)
  # --------------------------------------------------
  db:
    image: pgvector/pgvector:pg16
    container_name: agent-db
    environment:
      POSTGRES_DB: agent
      POSTGRES_USER: agent
      POSTGRES_PASSWORD: agent
    ports:
      - "5432:5432"          # optional: expose to host for debugging
    volumes:
      - pgdata:/var/lib/postgresql/data

  # --------------------------------------------------
  # MCP servers
  # --------------------------------------------------
  incident-mcp:
    build: ./servers/incident
    container_name: incident-mcp
    ports:
      - "8001:8001"
    environment:
      SENTRY_API_TOKEN: ${SENTRY_API_TOKEN}
      DD_API_KEY: ${DD_API_KEY}
      DD_APP_KEY: ${DD_APP_KEY}

  # github-mcp:
  #   build: ./servers/github
  #   container_name: github-mcp
  #   ports:
  #     - "8002:8002"
  #   environment:
  #     GITHUB_TOKEN: ${GITHUB_TOKEN}

  # jira-mcp:
  #   build: ./servers/jira
  #   container_name: jira-mcp
  #   ports:
  #     - "8003:8003"
  #   environment:
  #     JIRA_SERVER: ${JIRA_SERVER}
  #     JIRA_EMAIL: ${JIRA_EMAIL}
  #     JIRA_API_TOKEN: ${JIRA_API_TOKEN}

  memory-mcp:
    build: ./servers/memory
    container_name: memory-mcp
    ports:
      - "8004:8004"
    depends_on:
      - db
    environment:
      # IMPORTANT: use service name "db", not localhost
      MEMORY_DB_URL: postgres://agent:agent@db:5432/agent
      MEMORY_DB_NAME: agent
      MEMORY_DB_USER: agent
      MEMORY_DB_PASSWORD: agent
      MEMORY_DB_HOST: db
      MEMORY_DB_PORT: 5432
  
  code-indexer-mcp:
    build: ./servers/file
    container_name: code-indexer-mcp
    ports:
      - "8005:8005"
    environment:
    - CODE_INDEX_DIR=${CODE_INDEX_DIR}
    - CODE_INDEX_REPOS=${CODE_INDEX_REPOS}
    - CODE_INDEX_PATHS=${CODE_INDEX_PATHS}
    volumes:
      - ${CODE_INDEX_ROOT}:/host/artemis:ro
      - ${CODE_INDEX_DIR}:/code_index:rw
  
  editor-mcp:
    build: ./servers/editor
    container_name: editor-mcp
    ports:
      - "8006:8006"
    volumes:
      - ${CODE_INDEX_ROOT}:/host/artemis:rw
    
  shell-mcp:
    build: ./servers/shell
    container_name: shell-mcp
    ports:
      - "8007:8007"
    environment:
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_USER: ${GITHUB_USER}
      GITHUB_EMAIL: ${GITHUB_EMAIL}
    volumes:
      - ${CODE_INDEX_ROOT}:/host/artemis:rw

  # --------------------------------------------------
  # Agent
  # --------------------------------------------------
  ai-incident-agent:
    build:
      dockerfile: docker/Dockerfile
    container_name: ai-incident-agent
    depends_on:
      - db
      - incident-mcp
      # - github-mcp
      # - jira-mcp
      - memory-mcp
      - code-indexer-mcp
      - editor-mcp
      - shell-mcp
    environment:
      # MCP endpoints (Docker DNS)
      INCIDENT_SERVER: http://incident-mcp:8001/mcp
      GITHUB_SERVER:   http://github-mcp:8002/mcp
      JIRA_SERVER:     http://jira-mcp:8003/mcp
      MEMORY_SERVER:   http://memory-mcp:8004/mcp
      CODE_INDEX_SERVER: http://code-indexer-mcp:8005/mcp
      EDITOR_SERVER:   http://editor-mcp:8006/mcp
      SHELL_SERVER:    http://shell-mcp:8007/mcp

      # LLM
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
